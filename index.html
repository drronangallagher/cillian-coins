<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Cillian's Coin GOAT Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
    font-family: Arial, sans-serif;
    background: linear-gradient(135deg, #eef2f7, #d9e2ec);
    min-height: 100vh;
    margin: 0;
    padding: 20px;
    display: flex;
    justify-content: center;
    align-items: flex-start;
}

#app {
    background: #ffffff;
    max-width: 820px;
    width: 100%;
    border-radius: 14px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.12);
    padding: 24px 20px 28px 20px;
    text-align: center;
}

h1 {
    color: #2c3e50;
    margin-top: 0;
}

#controls {
    margin-bottom: 18px;
}

button {
    font-size: 15px;
    padding: 8px 12px;
    margin: 4px;
    cursor: pointer;
    border-radius: 8px;
    border: 1px solid #ccd6e0;
    background: #f7f9fc;
}

button:hover {
    background: #eef3f8;
}

button:disabled {
    cursor: not-allowed;
    opacity: 0.6;
}

#question {
    font-size: 22px;
    font-weight: bold;
    margin: 14px 0;
}

#coins {
    display: flex;
    justify-content: center;
    align-items: center;
    flex-wrap: wrap;
    gap: 6px;
    margin: 18px 0;
}

.coin {
    width: 72px;
    height: 72px;
    margin: 6px;
}

#dividerSymbol {
    font-size: 26px;
    font-weight: bold;
    color: #51606f;
    margin: 0 6px;
    user-select: none;
}

#answerRow {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 10px;
}

#answerBox {
    display: inline-flex;
    align-items: center;
    font-size: 18px;
}

#prefix, #suffix {
    font-size: 22px;
    margin: 0 6px;
    min-width: 20px;
    text-align: center;
}

input {
    font-size: 18px;
    padding: 6px;
    width: 140px;
    text-align: center;
    border-radius: 6px;
    border: 1px solid #cfd8e3;
}

#feedback {
    font-size: 20px;
    margin-top: 12px;
    min-height: 24px;
}

#solutionWrap {
    margin-top: 10px;
    display: none;
}

#solutionCard {
    background: #f7f9fc;
    border: 1px solid #dde6f0;
    border-radius: 10px;
    padding: 12px 12px;
    max-width: 700px;
    margin: 0 auto;
    text-align: left;
}

#solutionTitle {
    font-weight: bold;
    color: #2c3e50;
    margin-bottom: 6px;
}

#solution {
    font-size: 18px;
    white-space: pre-line;
    color: #34495e;
    line-height: 1.35;
}

#nextBtnWrap {
    margin-top: 10px;
    text-align: center;
}

#nextBtn {
    background: #e9f5ff;
    border: 1px solid #bcdfff;
}

#nextBtn:hover {
    background: #dff0ff;
}

#stats {
    font-size: 18px;
    margin-top: 14px;
}

#timer {
    font-size: 18px;
    margin-top: 8px;
}

#trophy {
    font-size: 64px;
    display: none;
    margin-top: 14px;
}

#hintLine {
    font-size: 14px;
    color: #6b7b8b;
    margin-top: 6px;
}
</style>
</head>

<body>
<div id="app">

<h1>Cillian's Coin GOAT</h1>

<div id="controls">
    <button id="modeBtn" onclick="toggleMode()">Mode: <span id="modeLabel">Addition</span></button>
    <button id="currencyBtn" onclick="toggleCurrency()">Answer in: <span id="currencyLabel">pence</span></button>
    <button id="timerBtn" onclick="toggleTimer()">Timer: <span id="timerLabel">Off</span></button>
    <button id="resetBtn" onclick="resetGame()">Reset</button>
</div>

<div id="question"></div>
<div id="coins"></div>
<div id="hintLine"></div>

<div id="answerRow">
    <div id="answerBox">
        <span id="prefix"></span>
        <input type="number" id="answer" inputmode="numeric">
        <span id="suffix"></span>
    </div>
    <button id="checkBtn" onclick="checkAnswer()">Check</button>
</div>

<div id="feedback"></div>

<div id="solutionWrap">
    <div id="solutionCard">
        <div id="solutionTitle">Worked solution</div>
        <div id="solution"></div>
        <div id="nextBtnWrap">
            <button id="nextBtn" onclick="acknowledgeSolution()">I Got It! - Next Question Please</button>
        </div>
    </div>
</div>

<div id="stats">
    Streak: <span id="streak">0</span> |
    Best: <span id="best">0</span>
</div>

<div id="timer"></div>
<div id="trophy">üèÜ</div>

<audio id="correctSound">
    <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=">
</audio>

<audio id="wrongSound">
    <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=">
</audio>

<script>
const coins = [
    { value: 1, img: "coins/1p.jpg" },
    { value: 2, img: "coins/2p.jpg" },
    { value: 5, img: "coins/5p.jpg" },
    { value: 10, img: "coins/10p.jpg" },
    { value: 20, img: "coins/20p.png" },
    { value: 50, img: "coins/50p.jpg" },
    { value: 100, img: "coins/1pound.jpg" },
    { value: 200, img: "coins/2pound.png" }
];

const valueToCoin = new Map(coins.map(c => [c.value, c]));

let modes = ["addition", "multiplication", "mixed", "subdivision", "random"];
let modeIndex = 0;

let currency = "pence";
let timerOn = false;

let currentCoins = [];
let steps = [];
let correctTotal = 0;

let answerType = "money"; // "money" or "count"
let correctCount = 0;

let streak = 0;
let best = 0;

let timeLeft = 0;
let timerInterval = null;

let lockedOnSolution = false;

function randomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

function modeLabelFromKey(key) {
    if (key === "addition") return "Addition";
    if (key === "multiplication") return "Multiplication";
    if (key === "mixed") return "Mixed";
    if (key === "subdivision") return "Subdivision";
    if (key === "random") return "Random";
    return key;
}

function setControlsEnabled(enabled) {
    document.getElementById("modeBtn").disabled = !enabled;
    document.getElementById("timerBtn").disabled = !enabled;
    document.getElementById("resetBtn").disabled = !enabled;
    document.getElementById("checkBtn").disabled = !enabled;
    document.getElementById("answer").disabled = !enabled;

    // Currency toggle is enabled only for money-answer problems
    document.getElementById("currencyBtn").disabled = !enabled || (answerType !== "money");
}

function toggleMode() {
    if (lockedOnSolution) return;
    modeIndex = (modeIndex + 1) % modes.length;
    document.getElementById("modeLabel").textContent = modeLabelFromKey(modes[modeIndex]);
    generateQuestion();
}

function toggleCurrency() {
    if (lockedOnSolution) return;
    if (answerType !== "money") return;

    currency = currency === "pence" ? "pounds" : "pence";
    document.getElementById("currencyLabel").textContent = currency;
    updateAnswerAffixes();
}

function toggleTimer() {
    if (lockedOnSolution) return;
    timerOn = !timerOn;
    document.getElementById("timerLabel").textContent = timerOn ? "On" : "Off";
    generateQuestion();
}

function resetGame() {
    if (lockedOnSolution) {
        lockedOnSolution = false;
    }
    streak = 0;
    best = 0;
    document.getElementById("streak").textContent = 0;
    document.getElementById("best").textContent = 0;
    document.getElementById("trophy").style.display = "none";
    hideSolution();
    generateQuestion();
}

function hideSolution() {
    document.getElementById("solutionWrap").style.display = "none";
    document.getElementById("solution").textContent = "";
}

function showSolution() {
    document.getElementById("solutionWrap").style.display = "block";
}

function clearUIForNewQuestion() {
    clearInterval(timerInterval);
    document.getElementById("timer").textContent = "";
    document.getElementById("feedback").textContent = "";
    document.getElementById("answer").value = "";
    document.getElementById("hintLine").textContent = "";
    hideSolution();
}

function formatValue(pence) {
    return pence >= 100 ? "¬£" + (pence / 100) : pence + "p";
}

function updateAnswerAffixes() {
    if (answerType !== "money") {
        document.getElementById("prefix").textContent = "";
        document.getElementById("suffix").textContent = "";
        return;
    }
    document.getElementById("prefix").textContent = currency === "pounds" ? "¬£" : "";
    document.getElementById("suffix").textContent = currency === "pence" ? "p" : "";
}

function renderCoins(options = {}) {
    const { showDivider = false, dividerText = "in" } = options;

    const c = document.getElementById("coins");
    c.innerHTML = "";

    if (!showDivider) {
        currentCoins.forEach(x => {
            const img = document.createElement("img");
            img.src = x.img;
            img.className = "coin";
            c.appendChild(img);
        });
        return;
    }

    // For subdivision style 1 (small coin on left, large on right):
    // currentCoins is expected to be [smallCoin, largeCoin]
    const left = currentCoins[0];
    const right = currentCoins[1];

    const imgL = document.createElement("img");
    imgL.src = left.img;
    imgL.className = "coin";
    c.appendChild(imgL);

    const div = document.createElement("div");
    div.id = "dividerSymbol";
    div.textContent = dividerText;
    c.appendChild(div);

    const imgR = document.createElement("img");
    imgR.src = right.img;
    imgR.className = "coin";
    c.appendChild(imgR);
}

function startTimer() {
    timeLeft = 10;
    document.getElementById("timer").textContent = "Time left: " + timeLeft;
    timerInterval = setInterval(() => {
        timeLeft--;
        document.getElementById("timer").textContent = "Time left: " + timeLeft;
        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            handleWrong();
        }
    }, 1000);
}

/* -------------------------
   Problem generators
--------------------------*/

function generateAdditionProblem() {
    answerType = "money";
    currentCoins = [];
    steps = [];
    correctTotal = 0;

    const count = randomInt(2, 4);
    let parts = [];
    for (let i = 0; i < count; i++) {
        const c = coins[randomInt(0, coins.length - 1)];
        currentCoins.push(c);
        correctTotal += c.value;
        parts.push(formatValue(c.value));
    }
    steps.push(parts.join(" + "));
    steps.push(correctTotal + "p");

    document.getElementById("question").textContent = "Add up the coins";
    document.getElementById("hintLine").textContent = steps[0];
    renderCoins();
}

function generateMultiplicationProblem() {
    answerType = "money";
    currentCoins = [];
    steps = [];
    correctTotal = 0;

    const coin = coins[randomInt(0, coins.length - 1)];
    const count = randomInt(2, 4);
    for (let i = 0; i < count; i++) currentCoins.push(coin);

    correctTotal = coin.value * count;

    steps.push(count + " √ó " + formatValue(coin.value));
    steps.push((count * coin.value) + "p");
    steps.push(correctTotal + "p");

    document.getElementById("question").textContent = steps[0];
    document.getElementById("hintLine").textContent = "";
    renderCoins();
}

function generateMixedProblem() {
    answerType = "money";
    currentCoins = [];
    steps = [];
    correctTotal = 0;

    const base = coins[randomInt(0, coins.length - 1)];
    const multCount = randomInt(2, 4);

    for (let i = 0; i < multCount; i++) {
        currentCoins.push(base);
        correctTotal += base.value;
    }

    let expression = "(" + multCount + " √ó " + formatValue(base.value) + ")";
    let expanded = (multCount * base.value) + "p";

    const extras = randomInt(1, 2);
    for (let i = 0; i < extras; i++) {
        let extra;
        do {
            extra = coins[randomInt(0, coins.length - 1)];
        } while (extra.value === base.value);

        currentCoins.push(extra);
        correctTotal += extra.value;
        expression += " + " + formatValue(extra.value);
        expanded += " + " + extra.value + "p";
    }

    steps.push(expression);
    steps.push(expanded);
    steps.push(correctTotal + "p");

    document.getElementById("question").textContent = steps[0];
    document.getElementById("hintLine").textContent = "";
    renderCoins();
}

function pickSubdivisionPair() {
    // Pick small coin in {1,2,5,10,20,50} and a larger coin value that is divisible by it.
    const smallChoices = [1, 2, 5, 10, 20, 50];
    const largeChoices = [10, 20, 50, 100, 200];

    let small = smallChoices[randomInt(0, smallChoices.length - 1)];
    let large = largeChoices[randomInt(0, largeChoices.length - 1)];

    // Ensure large > small and divisible
    let safety = 0;
    while ((large <= small) || (large % small !== 0)) {
        small = smallChoices[randomInt(0, smallChoices.length - 1)];
        large = largeChoices[randomInt(0, largeChoices.length - 1)];
        safety++;
        if (safety > 200) break;
    }
    return { small, large };
}

function generateSubdivisionProblem_Type1() {
    // "How many 2p coins are in 20p?"
    answerType = "count";
    currentCoins = [];
    steps = [];
    correctCount = 0;

    const { small, large } = pickSubdivisionPair();
    const smallCoin = valueToCoin.get(small);
    const largeCoin = valueToCoin.get(large);

    currentCoins = [smallCoin, largeCoin];
    correctCount = Math.round(large / small);

    const q = "How many " + formatValue(small) + " coins are in " + formatValue(large) + "?";
    document.getElementById("question").textContent = q;
    document.getElementById("hintLine").textContent = "";

    steps.push(formatValue(large) + " √∑ " + formatValue(small));
    steps.push(large + "p √∑ " + small + "p");
    steps.push(correctCount.toString());

    renderCoins({ showDivider: true, dividerText: "in" });
}

function makeRandomCoinSetWithTotal(totalPence, minCoins, maxCoins, allowedValues) {
    // Returns an array of coin objects whose values sum to totalPence.
    // Greedy with shuffling + retries to keep it simple and robust for small totals.
    const allowed = allowedValues.slice().sort((a, b) => b - a);
    let best = null;

    for (let attempt = 0; attempt < 200; attempt++) {
        let remaining = totalPence;
        let picked = [];

        const shuffled = allowed.slice().sort(() => Math.random() - 0.5);

        for (let i = 0; i < 100; i++) {
            if (remaining <= 0) break;
            const v = shuffled[randomInt(0, shuffled.length - 1)];
            if (v <= remaining) {
                picked.push(v);
                remaining -= v;
                if (picked.length >= maxCoins && remaining > 0) break;
            }
        }

        if (remaining === 0 && picked.length >= minCoins && picked.length <= maxCoins) {
            best = picked;
            break;
        }
    }

    if (!best) {
        // Fallback: use all 10p if possible, else 5p, else 2p, else 1p.
        best = [];
        let remaining = totalPence;
        const fallbackVals = allowed.slice().sort((a, b) => b - a);
        for (const v of fallbackVals) {
            while (remaining >= v && best.length < maxCoins) {
                best.push(v);
                remaining -= v;
            }
        }
        while (remaining > 0) {
            best.push(1);
            remaining -= 1;
        }
    }

    return best.map(v => valueToCoin.get(v));
}

function generateSubdivisionProblem_Type2() {
    // "How many 1p (or 2p/5p/10p) coins can I get for this set of coins?"
    answerType = "count";
    currentCoins = [];
    steps = [];
    correctCount = 0;

    const targetChoices = [1, 2, 5, 10];
    const target = targetChoices[randomInt(0, targetChoices.length - 1)];

    // Choose a count between 4 and 20 for the target coin, so totals are kid-friendly.
    const targetCount = randomInt(4, 20);
    const totalPence = target * targetCount;

    // Build a set of coins that sum to totalPence (2 to 5 coins)
    const allowedValues = [1, 2, 5, 10, 20, 50, 100, 200];
    currentCoins = makeRandomCoinSetWithTotal(totalPence, 2, 5, allowedValues);

    correctCount = Math.round(totalPence / target);

    const q = "How many " + formatValue(target) + " coins can you get for these coins?";
    document.getElementById("question").textContent = q;
    document.getElementById("hintLine").textContent = "Total √∑ " + formatValue(target);

    // Worked solution
    const coinText = currentCoins.map(c => formatValue(c.value)).join(" + ");
    steps.push(coinText);
    steps.push(totalPence + "p");
    steps.push(totalPence + "p √∑ " + target + "p");
    steps.push(correctCount.toString());

    renderCoins();
}

function generateSubdivisionProblem() {
    // Two styles, like your worksheet
    const pick = randomInt(0, 1);
    if (pick === 0) generateSubdivisionProblem_Type1();
    else generateSubdivisionProblem_Type2();
}

/* -------------------------
   Main question dispatcher
--------------------------*/

function generateQuestion() {
    if (lockedOnSolution) return;

    clearUIForNewQuestion();
    setControlsEnabled(true);

    let mode = modes[modeIndex];
    if (mode === "random") {
        const pick = randomInt(0, 3);
        mode = pick === 0 ? "addition" : (pick === 1 ? "multiplication" : (pick === 2 ? "mixed" : "subdivision"));
    }

    if (mode === "addition") generateAdditionProblem();
    if (mode === "multiplication") generateMultiplicationProblem();
    if (mode === "mixed") generateMixedProblem();
    if (mode === "subdivision") generateSubdivisionProblem();

    updateAnswerAffixes();

    document.getElementById("currencyBtn").disabled = (answerType !== "money");
    document.getElementById("currencyLabel").textContent = currency;

    if (timerOn) startTimer();
}

/* -------------------------
   Checking answers
--------------------------*/

function readUserAnswer() {
    let raw = document.getElementById("answer").value;
    if (raw === null || raw === undefined || raw === "") return null;

    const n = parseFloat(raw);
    if (isNaN(n)) return null;
    return n;
}

function checkAnswer() {
    if (lockedOnSolution) return;

    const input = readUserAnswer();
    if (input === null) return;

    if (answerType === "count") {
        const userCount = Math.round(input);
        if (userCount === correctCount) {
            document.getElementById("correctSound").play();
            streak++;
            best = Math.max(best, streak);
            document.getElementById("feedback").textContent = "Correct! üéâ";
            hideSolution();
            updateStats();
            setTimeout(generateQuestion, 700);
        } else {
            handleWrong();
        }
        return;
    }

    // money answer type
    const answerInPence = currency === "pounds" ? Math.round(input * 100) : Math.round(input);

    if (answerInPence === correctTotal) {
        document.getElementById("correctSound").play();
        streak++;
        best = Math.max(best, streak);
        document.getElementById("feedback").textContent = "Correct! üéâ";
        hideSolution();
        updateStats();
        setTimeout(generateQuestion, 900);
    } else {
        handleWrong();
    }
}

function handleWrong() {
    if (lockedOnSolution) return;

    clearInterval(timerInterval);
    document.getElementById("wrongSound").play();
    document.getElementById("feedback").textContent = "Not quite. Here is how to work it out:";

    // Show steps
    const text = steps.map((s, i) => (i === 0 ? s : "= " + s)).join("\n");
    document.getElementById("solution").textContent = text;
    showSolution();

    streak = 0;
    updateStats();

    lockedOnSolution = true;

    // Disable most controls while solution is shown
    document.getElementById("modeBtn").disabled = true;
    document.getElementById("currencyBtn").disabled = true;
    document.getElementById("timerBtn").disabled = true;
    document.getElementById("checkBtn").disabled = true;
    document.getElementById("answer").disabled = true;

    // Let reset still work
    document.getElementById("resetBtn").disabled = false;
}

function acknowledgeSolution() {
    lockedOnSolution = false;

    document.getElementById("modeBtn").disabled = false;
    document.getElementById("timerBtn").disabled = false;
    document.getElementById("resetBtn").disabled = false;
    document.getElementById("checkBtn").disabled = false;
    document.getElementById("answer").disabled = false;

    hideSolution();
    generateQuestion();
}

function updateStats() {
    document.getElementById("streak").textContent = streak;
    document.getElementById("best").textContent = best;
    document.getElementById("trophy").style.display = streak >= 10 ? "block" : "none";
}

/* -------------------------
   Init
--------------------------*/

document.getElementById("modeLabel").textContent = modeLabelFromKey(modes[modeIndex]);
document.getElementById("currencyLabel").textContent = currency;
document.getElementById("timerLabel").textContent = timerOn ? "On" : "Off";
updateAnswerAffixes();

document.getElementById("answer").addEventListener("keydown", function(e) {
    if (e.key === "Enter") checkAnswer();
});

generateQuestion();
</script>

</div>
</body>
</html>
